<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Batman1788 ÂïÜÂüé</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin:0; background:#f3f5f8; font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif; }
        .ad-banner { width:100%; height:120px; background:#1b1c1e; border-radius:0 0 20px 20px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
        .ad-banner img { width:98%; height:110px; object-fit:cover; border-radius:18px; box-shadow:0 2px 10px #0002; }
        .main { padding:8px 10px 70px 10px; max-width:520px; margin:0 auto; }
        .category-block { margin-bottom:18px; }
        .category-title { font-size:1.13em; font-weight:700; margin:14px 0 7px 5px; display:flex; align-items:center; gap:7px;}
        .goods-list {
            display: flex; flex-direction: row; gap: 14px; overflow-x: auto;
            padding-bottom: 8px; scrollbar-width: thin;
        }
        .goods-card { background:#fff; border-radius:15px; box-shadow:0 2px 8px #0001; padding:13px 12px; display:flex; flex-direction:column; align-items:center; position:relative; min-width:130px; max-width:150px; flex:0 0 auto;}
        .goods-img { width:66px; height:66px; object-fit:cover; border-radius:11px; border:1px solid #eee; background:#fafbfc; margin-bottom:8px; }
        .goods-title { font-size:1.03em; font-weight:600; margin-bottom:2px; text-align:center;}
        .badge { display:inline-block; background:#ffb940; color:#543; font-size:.93em; border-radius:7px; padding:1.5px 10px; margin-left:6px; margin-bottom:3px;}
        .tag-indica { background:#b6a7f5; color:#333; }
        .tag-sativa { background:#ffbb66; color:#222; }
        .goods-specs { margin:5px 0 0 0; text-align:center; }
        .goods-spec-btn { margin:3px 4px 0 0; border:none; border-radius:7px; background:#eee; padding:2px 10px; font-size:.99em; cursor:pointer; }
        .goods-spec-btn.selected { background:#1a73e8; color:#fff; }
        .goods-price { color:#e91e63; font-size:.97em; font-weight:600; margin-left:3px;}
        .cart-btn { background:#f78031; color:#fff; border:none; border-radius:7px; font-size:.96em; margin-top:7px; padding:6px 16px; cursor:pointer; }
        .goods-desc { color:#888; font-size:.91em; margin:2px 0 0 0;text-align:center;}
        .nav-bar { position:fixed; left:0; right:0; bottom:0; height:55px; background:#fff; border-top:1px solid #eee; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -2px 10px #0001; z-index:10;}
        .nav-btn { flex:1; text-align:center; color:#666; font-size:.98em; padding-top:5px; position:relative;}
        .nav-btn.active { color:#1a73e8; font-weight:600;}
        .nav-btn svg { display:block; margin:0 auto 2px auto;}
        .cart-count-dot { display:inline-block; position:absolute; right:26%; top:5px; background:#e91e63; color:#fff; border-radius:50%; min-width:18px; font-size:.92em; font-weight:700; padding:2px 5px; }
        .page { display:none; }
        .page.active { display:block; }
        /* Ë¥≠Áâ©ËΩ¶ÂºπÁ™ó */
        #cart-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; z-index:999; background:#0005; align-items:center; justify-content:center;}
        #cart-panel { background:#fff; border-radius:18px; max-width:410px; width:97%; margin:0 auto; padding:1.4em 1.1em 1.2em 1.1em; box-shadow:0 8px 32px #0003; display:flex; flex-direction:column; gap:10px; max-height:92vh; overflow:auto;}
        .cart-title { font-weight:700; font-size:1.13em; text-align:center; margin-bottom:.7em;}
        .cart-item { display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:7px 0;}
        .cart-item-img { width:42px; height:42px; border-radius:7px; object-fit:cover;}
        .cart-item-name { font-weight:500; }
        .cart-spec { color:#888; font-size:.93em; margin-left:3px;}
        .cart-qty-ctrl { display:flex; align-items:center; gap:6px;}
        .cart-qty-btn { background:#eee; border:none; font-size:1.1em; width:24px; height:24px; border-radius:5px; cursor:pointer; }
        .cart-del-btn { background:#ff9c9c; border:none; border-radius:6px; color:#fff; font-size:.93em; margin-left:7px; padding:1px 9px; cursor:pointer;}
        .cart-footer { margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:8px;}
        .cart-total { font-weight:600; font-size:1.07em;}
        #cartForm label {display:block; margin:10px 0 2px 0;}
        #cartForm input {width:100%; padding:6px; border-radius:5px; border:1px solid #ccc;}
        .cart-order-btn { background:#1a73e8; color:#fff; border:none; border-radius:9px; font-size:1.05em; padding:9px 0; width:100%; }
        .cart-close-btn { background:#eee; color:#444; border:none; border-radius:7px; margin-top:-2px; padding:6px 0; width:100%; }
        @media (max-width:600px) {
            .main {padding-bottom:90px;}
            .ad-banner {height:90px;}
            .ad-banner img {height:80px;}
            .goods-img { width:52px;height:52px;}
            .goods-card { width:48vw; min-width:132px;}
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂπøÂëäÔºåÂèØÊõøÊç¢‰Ω†ÁöÑbannerÂõæ -->
    <div class="ad-banner">
        <img src="https://raw.githubusercontent.com/ha05di/batman1788Menu/main/banner.png" alt="ÂπøÂëä">
    </div>
    <div class="main">
        <!-- È¶ñÈ°µÔºöÂàÜÂå∫ÂïÜÂìÅÂàóË°® -->
        <div class="page" id="page-home">
            <div id="main-content"></div>
        </div>
        <!-- ËÆ¢ÂçïÂàóË°® -->
        <div class="page" id="page-orders">
            <div style="text-align:center; color:#888; margin-top:40px;">ÊöÇÊú™ÂÆûÁé∞ËÆ¢ÂçïÂéÜÂè≤ÔºåÂèØÂêéÁª≠ÂØπÊé•</div>
        </div>
        <!-- ÊàëÁöÑ -->
        <div class="page" id="page-me">
            <div style="text-align:center; color:#888; margin-top:40px;">
                <div id="telegram-info"></div>
            </div>
        </div>
    </div>
    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="switchPage('home')">
            <svg width="22" height="22" fill="none"><rect x="3" y="8" width="16" height="11" rx="3" fill="currentColor"/><path d="M3 10L11 4l8 6" stroke="#1a73e8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            È¶ñÈ°µ
        </div>
        <div class="nav-btn" onclick="switchPage('orders')">
            <svg width="22" height="22" fill="none"><rect x="3" y="4" width="16" height="14" rx="3" fill="currentColor"/><path d="M7 8h8M7 12h5" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/></svg>
            ËÆ¢Âçï
        </div>
        <div class="nav-btn" onclick="showCartModal()">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="11" r="8" fill="currentColor"/><path d="M7 17h8M8 17v2h6v-2" stroke="#1a73e8" stroke-width="2"/><circle cx="15" cy="9" r="1" fill="#fff"/><circle cx="11" cy="9" r="1" fill="#fff"/><circle cx="7" cy="9" r="1" fill="#fff"/></svg>
            Ë¥≠Áâ©ËΩ¶
            <span id="cart-count" class="cart-count-dot" style="display:none"></span>
        </div>
    </div>
    <!-- Ë¥≠Áâ©ËΩ¶ÂºπÁ™ó -->
    <div id="cart-modal">
        <div id="cart-panel">
            <div class="cart-title">üõí ÊàëÁöÑË¥≠Áâ©ËΩ¶</div>
            <div id="cart-list"></div>
            <div class="cart-footer">
                <div class="cart-total">ÊÄª‰ª∑Ôºö<span id="cart-total">0</span></div>
                <form id="cartForm" onsubmit="submitCartOrder(event)">
                    <label>ÂßìÂêçÔºö<input name="name" required placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç"></label>
                    <label>ÁîµËØùÔºö<input name="phone" required placeholder="ÊâãÊú∫Âè∑"></label>
                    <label>Â§áÊ≥®Ôºö<input name="note" placeholder="ÂèØÈÄâ"></label>
                    <button type="submit" class="cart-order-btn">Êèê‰∫§ËÆ¢Âçï</button>
                </form>
                <button type="button" class="cart-close-btn" onclick="closeCartModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <script>
        // --- ÂÖ®Â±ÄÊï∞ÊçÆ ---
        let MENU = [];
        let SPEC_NAMES = ["Q", "H", "OZ"];
        let cart = [];
        // --- Sheet ÊãâÂèñ‰∏éÂàÜÁ±ªÂàÜÂå∫Ê∏≤Êüì ---
        function loadMenuFromSheet() {
            const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs/export?format=csv&gid=0";
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    MENU = results.data.filter(row => row['ÂêçÁß∞'] && row['ÊòØÂê¶‰∏äÊû∂'] !== 'N');
                    buildCategorySections();
                }
            });
        }
        function buildCategorySections() {
            const cats = {};
            MENU.forEach(item => {
                const cat = (item['ÂàÜÁ±ª']||'Êú™ÂàÜÁ±ª').trim();
                if (!cats[cat]) cats[cat]=[];
                cats[cat].push(item);
            });
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.entries(cats).forEach(([cat, items])=>{
                main.innerHTML += `
                <div class="category-block">
                    <div class="category-title">${catIcon(cat)} ${cat}</div>
                    <div class="goods-list">
                        ${items.map((item,idx)=>goodsCardHtml(item, idx)).join('')}
                    </div>
                </div>
                `;
            });
        }
        function catIcon(cat){
            if(cat.match(/food|È£üÁâ©/i)) return 'üçö';
            if(cat.match(/drink|È•ÆÊñô/i)) return 'ü•§';
            if(cat.match(/dessert|ÁîúÂìÅ/i)) return 'üç∞';
            if(cat.match(/snack|Â∞èÂêÉ/i)) return 'üç¢';
            return 'üçΩÔ∏è';
        }
        function goodsCardHtml(item, idx){
            let specs = [];
            SPEC_NAMES.forEach(spec => {
                if (item[spec] && item[spec].trim()) {
                    specs.push({ spec, price: item[spec].trim() });
                }
            });
            let tag = item['Ê†áÁ≠æ(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                           tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            let specBtns = specs.map((s,i)=>`
                <button class="goods-spec-btn" onclick="addToCart('${encodeURIComponent(JSON.stringify(item))}','${s.spec}','${s.price}');return false;">
                    ${s.spec}<span class="goods-price">Ôø•${s.price}</span>
                </button>
            `).join('');
            return `
            <div class="goods-card">
                <img class="goods-img" src="${item['ÂõæÁâá_URL']||''}" alt="${item['ÂêçÁß∞']}">
                <div class="goods-title">
                    ${item['ÂêçÁß∞']}
                    ${tag?`<span class="${tagClass}">${tag}</span>`:""}
                </div>
                ${item['Â§áÊ≥®']?`<div class="goods-desc">${item['Â§áÊ≥®']}</div>`:""}
                <div class="goods-specs">${specBtns}</div>
                <button class="cart-btn" onclick="addToCart('${encodeURIComponent(JSON.stringify(item))}','${specs[0]?.spec}','${specs[0]?.price}');return false;">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
            </div>
            `;
        }
        // --- Ë¥≠Áâ©ËΩ¶Ê†∏ÂøÉ ---
        function addToCart(itemStr, spec, price) {
            const item = JSON.parse(decodeURIComponent(itemStr));
            if (!spec) {
                alert("ËØ∑ÈÄâÊã©ËßÑÊ†º");
                return;
            }
            let idx = cart.findIndex(c => c.id === item.id && c.spec === spec);
            if (idx >= 0) {
                cart[idx].qty += 1;
            } else {
                cart.push({
                    id: item.id,
                    name: item['ÂêçÁß∞'],
                    img: item['ÂõæÁâá_URL'],
                    tag: item['Ê†áÁ≠æ(tag)'],
                    spec,
                    price: Number(price),
                    qty: 1
                });
            }
            updateCartBadge();
            showCartTip();
        }
        function updateCartBadge() {
            let n = cart.reduce((s,c)=>s+c.qty,0);
            let badge = document.getElementById('cart-count');
            if (n>0) {
                badge.innerText = n;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        function showCartTip() {
            // ÁÆÄÂçïÂä®ÁîªÔºåÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶Êó∂ÊèêÁ§∫
            let badge = document.getElementById('cart-count');
            badge.animate([
                {transform:'scale(1.3)',background:'#ffb940'},
                {transform:'scale(1)',background:'#e91e63'}
            ],{duration:300});
        }
        function showCartModal() {
            renderCartList();
            document.getElementById('cart-modal').style.display='flex';
        }
        function closeCartModal(){
            document.getElementById('cart-modal').style.display='none';
        }
        function renderCartList() {
            let list = document.getElementById('cart-list');
            if (cart.length === 0) {
                list.innerHTML = `<div style="text-align:center;color:#888;margin:24px 0;">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ</div>`;
                document.getElementById('cart-total').innerText = 0;
                return;
            }
            list.innerHTML = cart.map((c,i)=>`
                <div class="cart-item">
                    <img src="${c.img}" class="cart-item-img">
                    <div style="flex:1">
                        <div class="cart-item-name">${c.name}
                            ${c.tag?`<span class="badge">${c.tag}</span>`:""}
                        </div>
                        <div class="cart-spec">${c.spec}</div>
                        <div class="cart-price">Ôø•${c.price} √ó ${c.qty}</div>
                    </div>
                    <div class="cart-qty-ctrl">
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},-1)">-</button>
                        <span>${c.qty}</span>
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},1)">+</button>
                        <button class="cart-del-btn" onclick="removeFromCart(${i})">Âà†</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cart-total').innerText = cart.reduce((s,c)=>s+c.price*c.qty,0);
        }
        function changeCartQty(idx,delta){
            cart[idx].qty+=delta;
            if(cart[idx].qty<=0) cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        function removeFromCart(idx){
            cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        // --- Êèê‰∫§Ë¥≠Áâ©ËΩ¶ËÆ¢Âçï ---
        async function submitCartOrder(e) {
            e.preventDefault();
            const user = window.telegramUser;
            if (!user) {
                alert("ËØ∑Âú® Telegram ÂÜÖÈÉ®ÊâìÂºÄÊú¨È°µÈù¢");
                return;
            }
            if(cart.length===0){
                alert("Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ");
                return;
            }
            let formData = Object.fromEntries(new FormData(e.target));
            let payload = {
                ...formData,
                telegram_id: user.id,
                telegram_name: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                items: cart
            };
            let btn = e.target.querySelector('.cart-order-btn');
            btn.disabled=true; btn.innerText="Êèê‰∫§‰∏≠...";
            const resp = await fetch("https://batmanshop.onrender.com/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            btn.disabled=false; btn.innerText="Êèê‰∫§ËÆ¢Âçï";
            if (resp.ok) {
                alert("‰∏ãÂçïÊàêÂäüÔºÅ");
                cart = []; updateCartBadge(); closeCartModal();
            } else {
                alert("Êèê‰∫§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ");
            }
        }
        // --- Â∫ïÈÉ®ÂØºËà™Ê†èÂàáÊç¢ ---
        function switchPage(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            let navOrder={'home':0,'orders':1,'me':2};
            document.querySelectorAll('.nav-btn')[navOrder[p]].classList.add('active');
        }
        switchPage('home');
        // --- TelegramÁôªÂΩï‰ø°ÊÅØ ---
        window.onload = function () {
            loadMenuFromSheet();
            if (window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                window.telegramUser = user;
                document.getElementById('telegram-info').innerHTML =
                    `<b>${user.first_name || ''} ${user.last_name || ''}</b> <span style="color:#888">(ID: ${user.id})</span><br>${user.username ? '@'+user.username : ''}`;
            } else {
                document.getElementById('telegram-info').innerHTML =
                    `<span style="color:#e55">ËØ∑Âú® Telegram ÂÜÖÈÉ®ÊâìÂºÄÔºàÁÇπÂáªËèúÂçï/ÊåâÈíÆËøõÂÖ•Ôºâ</span>`;
            }
        }
    </script>
</body>
</html>
