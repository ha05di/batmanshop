<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Batman1788 下单</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body { font-family: 'Segoe UI',Arial,sans-serif; background: #f3f6fa; margin: 0; padding: 0; }
        .container { max-width: 520px; margin: 30px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #0001; padding: 20px;}
        .menu-card { display: flex; align-items: flex-start; gap: 16px; margin-bottom: 28px; border-bottom: 1px solid #f0f0f0; padding-bottom: 18px;}
        .menu-card:last-child { border-bottom: none; }
        .menu-img { width: 88px; height: 88px; object-fit: cover; border-radius: 12px; border: 1px solid #eee;}
        .menu-info { flex: 1; }
        .menu-title { font-size: 20px; font-weight: bold; margin-bottom: 6px;}
        .menu-tags { font-size: 13px; color: #99a; margin-bottom: 7px;}
        .menu-prices { font-size: 15px; margin-bottom: 6px;}
        .order-btn { background: #3296fa; color: #fff; border: none; padding: 7px 20px; border-radius: 5px; font-size: 15px; cursor: pointer;}
        .order-btn:active { background: #166ad6; }
        .login-info { margin-bottom: 22px; }
        .tg-login-wrap { margin-bottom: 20px; }
        @media (max-width:600px) { .container { border-radius: 0; box-shadow:none; } }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center;letter-spacing:2px;">Batman1788 下单表单</h2>
    <div id="loginSection" class="tg-login-wrap"></div>
    <div id="userInfo" class="login-info"></div>
    <div id="menuList"></div>
</div>

<!-- Telegram Login Widget -->
<script async src="https://telegram.org/js/telegram-widget.js?7"
    data-telegram-login="batmangiveawaybot"  <!-- 换成你的Bot用户名 -->
    data-size="large"
    data-userpic="true"
    data-request-access="write"
    data-onauth="onTelegramAuth(user)">
</script>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs/export?format=csv&id=1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs&gid=0"; // 替换为你的
const FLASK_ORDER_API = "https://batmanshop.onrender.com/order"; // 替换为你的后端

let telegramUser = null;

// Telegram 登录回调
function onTelegramAuth(user) {
    telegramUser = user;
    document.getElementById('userInfo').innerHTML = `<b>已登录：</b>${user.first_name || ''} <span style="color:#888">(@${user.username||''})</span>`;
    document.getElementById('loginSection').style.display = 'none';
}

// 加载 Sheet CSV 转成对象数组
async function loadMenuFromSheet() {
    const resp = await fetch(SHEET_CSV_URL);
    const csv = await resp.text();
    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',').map(h=>h.trim());
    const menu = lines.slice(1).map(line=>{
        // 允许备注有逗号，做简单split
        let arr = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'').trim());
        let obj = {};
        headers.forEach((h,i)=>obj[h]=arr[i]||'');
        return obj;
    }).filter(row=>row['是否上架']!=='0' && row['是否上架']!=='否');
    return menu;
}

// 渲染菜单
function renderMenu(menu) {
    let html = '';
    for (const item of menu) {
        html += `
        <div class="menu-card">
            <img class="menu-img" src="${item['图片_URL']||''}" alt="${item['名称']}">
            <div class="menu-info">
                <div class="menu-title">${item['名称']||''}</div>
                <div class="menu-tags">${item['标签(tag)']||''}</div>
                <div class="menu-prices">
                    <span>Q: ¥${item['Q']||'-'}</span> &nbsp; 
                    <span>H: ¥${item['H']||'-'}</span> &nbsp; 
                    <span>OZ: ${item['OZ']||'-'}</span>
                </div>
                <div class="menu-tags">${item['备注']||''}</div>
                <button class="order-btn" onclick='orderNow(${JSON.stringify(item).replace(/'/g,"\\'")})'>下单</button>
            </div>
        </div>`;
    }
    document.getElementById('menuList').innerHTML = html;
}

// 下单（弹窗输入数量+备注，或直接1份）
function orderNow(item) {
    if (!telegramUser) { alert("请先用 Telegram 登录"); return; }
    let qty = prompt(`下单数量（默认1）：`, '1');
    if (!qty || isNaN(qty) || qty<=0) return;
    let note = prompt(`备注（可留空）：`, '');
    let orderData = {
        ...item,
        qty, note,
        telegram_id: telegramUser.id,
        telegram_username: telegramUser.username,
        first_name: telegramUser.first_name,
        last_name: telegramUser.last_name,
        photo_url: telegramUser.photo_url || ''
    };
    fetch(FLASK_ORDER_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
    }).then(async resp=>{
        if (resp.ok) {
            alert("下单成功！我们会尽快联系您。");
        } else {
            let err = await resp.text();
            alert("提交失败！" + err);
        }
    });
}

// 页面加载
(async function(){
    document.getElementById('loginSection').style.display = '';
    let menu = await loadMenuFromSheet();
    renderMenu(menu);
})();
</script>
</body>
</html>
