<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Batman1788 下单表单</title>
  <style>
    body { font-family: system-ui,sans-serif; background: #f5f6fa; margin: 0; }
    .container { max-width: 420px; margin: 36px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 18px #0001; padding: 36px 24px; }
    h2 { text-align: center; }
    .item-card { display: flex; align-items: center; margin: 12px 0; border-bottom: 1px solid #eee; padding-bottom: 10px;}
    .item-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; margin-right: 14px;}
    .item-info { flex: 1; }
    .item-name { font-weight: bold; }
    .item-tag { font-size: 12px; color: #888;}
    .item-price { margin-top: 5px; color: #C94;}
    .login-wrap { text-align:center;margin-bottom:20px;}
    .tg-login {margin-bottom:18px;}
    #orderForm {margin-top:20px;}
    .submit-btn {margin-top:20px; width:100%;padding:10px; border:none; border-radius:6px; background:#2481CC; color:#fff; font-size:16px;}
  </style>
  <!-- Telegram 登录按钮 JS -->
  <script src="https://telegram.org/js/telegram-widget.js?7"
    data-telegram-login="batmangiveawaybot"
    data-size="large"
    data-userpic="true"
    data-request-access="write"
    data-onauth="onTelegramAuth(user)"
    async>
  </script>
</head>
<body>
  <div class="container">
    <h2>Batman1788 下单表单</h2>
    <div id="tg-login" class="login-wrap">
      <div>请先用 <b>Telegram 登录</b></div>
      <!-- Telegram 登录按钮会自动插入这里 -->
    </div>
    <div id="user-info" style="display:none"></div>

    <div id="menu-list"></div>
    <form id="orderForm" style="display:none" onsubmit="submitOrder(event)">
      <input type="hidden" name="telegram_id" />
      <input type="hidden" name="telegram_name" />
      <input type="hidden" name="first_name" />
      <input type="hidden" name="last_name" />
      <input type="hidden" name="photo_url" />

      <div>数量：<input name="qty" type="number" value="1" min="1" style="width:60px"></div>
      <div>备注：<input name="note" style="width:90%"></div>
      <button type="submit" class="submit-btn">提交订单</button>
    </form>
  </div>
  <script>
    // 你的 Google Sheet CSV 直链
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs/export?format=csv&id=1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs&gid=0";
    // 你的后端接口
    const ORDER_API = "https://batmanshop.onrender.com/order";

    let currentUser = null, selectedItem = null, menuItems = [];

    // 解析 CSV 并渲染菜单
    fetch(SHEET_CSV_URL).then(r => r.text()).then(csv => {
      const rows = csv.trim().split('\n').map(line => line.split(','));
      const header = rows[0];
      menuItems = rows.slice(1).map(row => {
        const obj = {};
        header.forEach((k, i) => obj[k.trim()] = row[i] ? row[i].trim() : '');
        return obj;
      }).filter(item => item['是否上架'] !== '0');
      showMenu();
    });

    function showMenu() {
      const menuList = document.getElementById('menu-list');
      menuList.innerHTML = menuItems.map(item => `
        <div class="item-card" onclick="selectItem('${item.id}')">
          <img src="${item.图片_URL}" />
          <div class="item-info">
            <div class="item-name">${item.名称}</div>
            <div class="item-tag">${item.标签(tag) || ''}</div>
            <div class="item-price">Q: ${item.Q} | H: ${item.H} | OZ: ${item.OZ}</div>
          </div>
        </div>
      `).join('');
    }

    // 选择商品
    window.selectItem = function(id) {
      selectedItem = menuItems.find(i => i.id === id);
      document.getElementById('orderForm').style.display = '';
      // 可以在表单上显示选中的商品，也可以填入隐藏 input
      document.querySelector('#orderForm [name="item"]').value = selectedItem.名称;
    }

    // Telegram 登录回调
    function onTelegramAuth(user) {
      currentUser = user;
      document.getElementById('tg-login').style.display = "none";
      document.getElementById('user-info').style.display = "";
      document.getElementById('user-info').innerHTML =
        `已登录: <b>${user.first_name || ''} ${user.last_name || ''}</b> <span style="color:#888;">@${user.username}</span>`;
      // 填充到 form 隐藏域
      ['id','username','first_name','last_name','photo_url'].forEach(k => {
        document.querySelector(`#orderForm [name="telegram_${k.replace('id', 'id')}"]`).value = user[k] || '';
      });
    }

    // 下单
    async function submitOrder(e) {
      e.preventDefault();
      if (!currentUser) return alert("请先用 Telegram 登录！");
      if (!selectedItem) return alert("请先选择商品！");
      const fd = new FormData(e.target);
      fd.append('item', selectedItem.名称);
      fd.append('item_id', selectedItem.id);
      fd.append('item_pic', selectedItem.图片_URL);
      fd.append('item_price', selectedItem.Q); // 这里也可以选其他规格
      const obj = {};
      for (const [k,v] of fd.entries()) obj[k] = v;
      const resp = await fetch(ORDER_API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(obj)
      });
      if (resp.ok) alert("下单成功！"); else alert("提交失败！");
      e.target.reset();
    }
  </script>
</body>
</html>
