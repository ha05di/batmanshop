<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Batman1788 å•†åŸ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin:0; background:#f3f5f8; font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif; }
        .ad-banner { width:100%; height:120px; background:#1b1c1e; border-radius:0 0 20px 20px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
        .ad-banner img { width:98%; height:110px; object-fit:cover; border-radius:18px; box-shadow:0 2px 10px #0002; }
        .main { padding:8px 10px 70px 10px; max-width:520px; margin:0 auto; }
        .category-block { margin-bottom:18px; }
        .category-title { font-size:1.13em; font-weight:700; margin:14px 0 7px 5px; display:flex; align-items:center; gap:7px;}
        .goods-list {
            display: flex; flex-direction: row; gap: 14px; overflow-x: auto;
            padding-bottom: 8px; scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .goods-list::-webkit-scrollbar { display: none; }
        .goods-card { background:#fff; border-radius:15px; box-shadow:0 2px 8px #0001; padding:13px 12px; display:flex; flex-direction:column; align-items:center; position:relative; min-width:130px; max-width:150px; flex:0 0 auto; cursor:pointer; transition:box-shadow .18s;}
        .goods-card:active { box-shadow:0 4px 16px #0002;}
        .goods-img { width:66px; height:66px; object-fit:cover; border-radius:11px; border:1px solid #eee; background:#fafbfc; margin-bottom:8px; }
        .goods-title { font-size:1.03em; font-weight:600; margin-bottom:2px; text-align:center;}
        .badge { display:inline-block; background:#ffb940; color:#543; font-size:.93em; border-radius:7px; padding:1.5px 10px; margin-left:6px; margin-bottom:3px;}
        .tag-indica { background:#b6a7f5; color:#333; }
        .tag-sativa { background:#ffbb66; color:#222; }
        .goods-specs { margin:5px 0 0 0; text-align:center; }
        .goods-desc { color:#888; font-size:.91em; margin:2px 0 0 0;text-align:center;}
        .nav-bar { position:fixed; left:0; right:0; bottom:0; height:55px; background:#fff; border-top:1px solid #eee; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -2px 10px #0001; z-index:10;}
        .nav-btn { flex:1; text-align:center; color:#666; font-size:.98em; padding-top:5px; position:relative;}
        .nav-btn.active { color:#1a73e8; font-weight:600;}
        .nav-btn svg { display:block; margin:0 auto 2px auto;}
        .cart-count-dot { display:inline-block; position:absolute; right:28%; top:5px; background:#e91e63; color:#fff; border-radius:50%; min-width:18px; font-size:.92em; font-weight:700; padding:2px 5px; }
        .page { display:none; }
        .page.active { display:block; }
        /* å•†å“è¯¦æƒ…å¼¹çª— */
        #item-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; z-index:999; background:#0005; align-items:center; justify-content:center;}
        #item-panel { background:#fff; border-radius:18px; max-width:410px; width:97%; margin:0 auto; padding:1.3em 1.1em 1.2em 1.1em; box-shadow:0 8px 32px #0003; display:flex; flex-direction:column; gap:10px; max-height:92vh; overflow:auto;}
        .item-modal-img { width:80px;height:80px; border-radius:12px; object-fit:cover; margin:0 auto 5px auto; cursor:pointer;}
        .item-modal-title { font-size:1.12em; font-weight:700; text-align:center;}
        .item-modal-tag { margin-left:8px; }
        .item-modal-desc { color:#888; font-size:.96em; margin-bottom:.6em; text-align:center;}
        .item-modal-specs { text-align:center; margin:0 0 9px 0;}
        .item-spec-btn { border:none; border-radius:7px; background:#eee; padding:4px 14px; font-size:.99em; cursor:pointer; margin:0 5px 5px 0;}
        .item-spec-btn.selected { background:#1a73e8; color:#fff; }
        .item-modal-qty { display:flex;align-items:center;justify-content:center;gap:12px;margin:8px 0;}
        .item-qty-btn { background:#eee; border:none; font-size:1.16em; width:26px; height:26px; border-radius:6px; cursor:pointer; }
        .item-modal-footer { display:flex; flex-direction:column; align-items:center; gap:6px;}
        .item-modal-cart-btn { background:#f78031; color:#fff; border:none; border-radius:9px; font-size:1.05em; padding:10px 0; width:100%; }
        .item-modal-close-btn { background:#eee; color:#444; border:none; border-radius:7px; margin-top:-2px; padding:7px 0; width:100%; }
        /* è´­ç‰©è½¦å¼¹çª— */
        #cart-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; z-index:999; background:#0005; align-items:center; justify-content:center;}
        #cart-panel { background:#fff; border-radius:18px; max-width:410px; width:97%; margin:0 auto; padding:1.4em 1.1em 1.2em 1.1em; box-shadow:0 8px 32px #0003; display:flex; flex-direction:column; gap:10px; max-height:92vh; overflow:auto;}
        .cart-title { font-weight:700; font-size:1.13em; text-align:center; margin-bottom:.7em;}
        .cart-item { display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:7px 0;}
        .cart-item-img { width:42px; height:42px; border-radius:7px; object-fit:cover;}
        .cart-item-name { font-weight:500; }
        .cart-spec { color:#888; font-size:.93em; margin-left:3px;}
        .cart-qty-ctrl { display:flex; align-items:center; gap:6px;}
        .cart-qty-btn { background:#eee; border:none; font-size:1.1em; width:24px; height:24px; border-radius:5px; cursor:pointer; }
        .cart-del-btn { background:#ff9c9c; border:none; border-radius:6px; color:#fff; font-size:.93em; margin-left:7px; padding:1px 9px; cursor:pointer;}
        .cart-footer { margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:8px;}
        .cart-total { font-weight:600; font-size:1.07em;}
        #cartForm label {display:block; margin:10px 0 2px 0;}
        #cartForm input, #cartForm select {width:100%; padding:6px; border-radius:5px; border:1px solid #ccc;}
        .cart-order-btn { background:#1a73e8; color:#fff; border:none; border-radius:9px; font-size:1.05em; padding:9px 0; width:100%; }
        .cart-close-btn { background:#eee; color:#444; border:none; border-radius:7px; margin-top:-2px; padding:6px 0; width:100%; }
        /* æˆ‘çš„é¡µç¾åŒ– */
        .me-container { max-width:340px; margin:0 auto; padding:12px 0 18px 0;}
        .me-card { background:#fff; border-radius:16px; box-shadow:0 4px 18px #0001; padding:18px 18px 14px 18px; margin-bottom:16px;}
        #userInfoForm, #addressForm { display:flex; gap:10px; flex-wrap:wrap;}
        #userInfoForm input, #addressForm input { flex:1; padding:8px 10px; font-size:1.03em; border:1px solid #ccc; border-radius:8px; background:#fafbfc;}
        .me-btn-primary { background:#1a73e8; color:#fff; border:none; border-radius:8px; font-size:1em; padding:7px 18px; cursor:pointer; transition:all .18s;}
        .me-btn-primary:active { background:#1763c5; }
        #address-list .addr-row { display:flex;align-items:center;justify-content:space-between;background:#f5f7fa;padding:7px 12px;margin-bottom:7px;border-radius:8px;}
        #address-list .addr-del { background:#ffcdd2;color:#b22;border:none;border-radius:6px;padding:3px 10px;font-size:.96em;cursor:pointer; }
        #address-list .addr-del:active {background:#ffa1a1;}
        /* è®¢å•å†å²å¡ç‰‡ */
        .order-card { background:#fff; border-radius:13px; box-shadow:0 2px 8px #0001; padding:15px 12px 11px 12px; margin-bottom:15px; }
        .order-header { font-size:1.01em;font-weight:600;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
        .order-status { font-size:.98em; color:#1a73e8; font-weight:600;}
        .order-addr { color:#888; font-size:.95em; margin-bottom:3px;}
        .order-items { font-size:.97em;margin-bottom:5px;}
        .order-note { color:#ff9000;font-size:.93em;margin-bottom:4px;}
        @media (max-width:600px){
          .me-container {padding:6px 0;}
          .me-card {padding:13px 8px 10px 8px;}
          .main {padding-bottom:90px;}
          .ad-banner {height:90px;}
          .ad-banner img {height:80px;}
          .goods-img { width:52px;height:52px;}
          .goods-card { width:48vw; min-width:132px;}
          #item-panel {padding:1em .5em;}
          #cart-panel {padding:1em .5em;}
        }
        /* å¤§å›¾æŸ¥çœ‹å™¨ */
        #img-viewer { display:none; position:fixed;z-index:2000;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.97);align-items:center;justify-content:center;}
        #img-viewer-pic { max-width:95vw;max-height:85vh;border-radius:20px;box-shadow:0 4px 40px #0007;transition:all .2s;}
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¹¿å‘Š -->
    <div class="ad-banner">
        <img src="https://raw.githubusercontent.com/ha05di/batman1788Menu/main/banner/coffee-banner.jpg" alt="å¹¿å‘Š">
    </div>
    <div class="main">
        <!-- é¦–é¡µèœå• -->
        <div class="page" id="page-home">
            <div id="main-content"></div>
        </div>
        <!-- è®¢å•å†å² -->
        <div class="page" id="page-orders">
          <div style="max-width:360px;margin:0 auto;">
            <div class="orders-title" style="font-size:1.12em;font-weight:700;margin:12px 0 10px 0;">æˆ‘çš„è®¢å•</div>
            <div id="orders-list">
              <div style="color:#aaa;text-align:center;margin-top:40px;">æ­£åœ¨åŠ è½½è®¢å•â€¦</div>
            </div>
          </div>
        </div>
        <!-- æˆ‘çš„ -->
        <div class="page" id="page-me">
          <div class="me-container">
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div class="me-card">
              <div style="display:flex;align-items:center;gap:13px;">
                <img src="https://telegram.org/img/t_logo.png" width="40" style="border-radius:50%;background:#f7f7fa;">
                <div style="flex:1">
                  <div id="me-nick" style="font-size:1.11em;font-weight:600;"></div>
                  <div id="me-uid" style="color:#999;font-size:.97em;margin-top:1px;"></div>
                </div>
              </div>
            </div>
            <!-- ä¸‹å•äººä¿¡æ¯è¡¨å• -->
            <div class="me-card">
              <div style="font-size:1.09em;font-weight:600;margin-bottom:10px;">æ”¶ä»¶äººä¿¡æ¯</div>
              <form id="userInfoForm" onsubmit="saveUserInfo(event)" autocomplete="off" style="display:flex;gap:9px;flex-wrap:wrap;">
                <input name="name" required placeholder="å§“å">
                <input name="phone" required placeholder="ç”µè¯">
                <button type="submit" class="me-btn-primary" id="user-info-save-btn">ä¿å­˜</button>
                <span id="user-info-saved" style="color:#4caf50;font-weight:500;display:none;margin-left:13px;font-size:.96em;">âœ” å·²ä¿å­˜</span>
              </form>
            </div>
            <!-- åœ°å€ç®¡ç† -->
            <div class="me-card">
              <div style="display:flex;align-items:center;justify-content:space-between;">
                <div style="font-size:1.09em;font-weight:600;">é€è´§åœ°å€</div>
              </div>
              <div id="address-list" style="margin-bottom:8px;"></div>
              <form id="addressForm" onsubmit="addAddress(event)" style="display:flex;gap:7px;">
                <input name="address" required placeholder="æ·»åŠ æ–°åœ°å€">
                <button type="submit" class="me-btn-primary" style="white-space:nowrap;">æ·»åŠ </button>
              </form>
            </div>
          </div>
        </div>
    </div>
    <!-- åº•éƒ¨å¯¼èˆªæ ï¼Œå››æ  -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="switchPage('home')">
            <svg width="22" height="22" fill="none"><rect x="3" y="8" width="16" height="11" rx="3" fill="currentColor"/><path d="M3 10L11 4l8 6" stroke="#1a73e8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            é¦–é¡µ
        </div>
        <div class="nav-btn" onclick="switchPage('orders')">
            <svg width="22" height="22" fill="none"><rect x="3" y="4" width="16" height="14" rx="3" fill="currentColor"/><path d="M7 8h8M7 12h5" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/></svg>
            è®¢å•
        </div>
        <div class="nav-btn" onclick="showCartModal()">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="11" r="8" fill="currentColor"/><path d="M7 17h8M8 17v2h6v-2" stroke="#1a73e8" stroke-width="2"/><circle cx="15" cy="9" r="1" fill="#fff"/><circle cx="11" cy="9" r="1" fill="#fff"/><circle cx="7" cy="9" r="1" fill="#fff"/></svg>
            è´­ç‰©è½¦
            <span id="cart-count" class="cart-count-dot" style="display:none"></span>
        </div>
        <div class="nav-btn" onclick="switchPage('me')">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="9" r="4" fill="currentColor"/><rect x="5" y="15" width="12" height="5" rx="3" fill="currentColor"/></svg>
            æˆ‘
        </div>
    </div>
    <!-- å•†å“è¯¦æƒ…å¼¹çª— -->
    <div id="item-modal">
        <div id="item-panel">
            <img id="item-modal-img" class="item-modal-img" src="" onclick="showImgViewer(this.src)">
            <div class="item-modal-title" id="item-modal-title"></div>
            <div class="item-modal-tag" id="item-modal-tag"></div>
            <div class="item-modal-desc" id="item-modal-desc"></div>
            <div class="item-modal-specs" id="item-modal-specs"></div>
            <div class="item-modal-qty">
                <button class="item-qty-btn" onclick="changeModalQty(-1)">-</button>
                <span id="item-modal-qty-val">1</span>
                <button class="item-qty-btn" onclick="changeModalQty(1)">+</button>
            </div>
            <div class="item-modal-footer">
                <button class="item-modal-cart-btn" onclick="addModalToCart()">åŠ å…¥è´­ç‰©è½¦</button>
                <button class="item-modal-close-btn" onclick="closeItemModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    <!-- è´­ç‰©è½¦å¼¹çª— -->
    <div id="cart-modal">
        <div id="cart-panel">
            <div class="cart-title">ğŸ›’ æˆ‘çš„è´­ç‰©è½¦</div>
            <div id="cart-list"></div>
            <div class="cart-footer">
                <div class="cart-total">æ€»ä»·ï¼š<span id="cart-total">0</span></div>
                <form id="cartForm" onsubmit="submitCartOrder(event)">
                    <label>é€è´§åœ°å€ï¼š
                        <select name="address" id="address-select" required style="width:100%;padding:7px;border-radius:5px;">
                            <!-- JS æ¸²æŸ“ -->
                        </select>
                    </label>
                    <label>å¤‡æ³¨ï¼š<input name="note" placeholder="å¯é€‰"></label>
                    <button type="submit" class="cart-order-btn">æäº¤è®¢å•</button>
                </form>
                <button type="button" class="cart-close-btn" onclick="closeCartModal()">å…³é—­</button>
                <div id="cart-user-tips" style="color:#e55;font-size:.98em;margin-top:5px;display:none;"></div>
            </div>
        </div>
    </div>
    <!-- å¤§å›¾å…¨å±æŸ¥çœ‹å™¨ -->
    <div id="img-viewer" style="display:none;position:fixed;z-index:2000;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.97);align-items:center;justify-content:center;">
        <img id="img-viewer-pic" src="" style="max-width:95vw;max-height:85vh;border-radius:20px;box-shadow:0 4px 40px #0007;transition:all .2s;">
    </div>
    <script>
        // === å…¨å±€å˜é‡ ===
        let MENU = [];
        let SPEC_NAMES = ["Q", "H", "OZ"];
        let cart = [];

        // Google Apps Script API åœ°å€
        const SHEET_API = "https://script.google.com/macros/s/AKfycbxnvmEvUOwcdl0mOq1pqYIuELIDkN8ZOGe4H-ed2eIa9yMBxrPqALN2hQy5jCtJ6gmA/exec";

        // --- Sheet èœå•æ‹‰å–ä¸åˆ†ç±»åˆ†åŒºæ¸²æŸ“ ---
        function loadMenuFromSheet() {
            fetch(`${SHEET_API}?sheet=menu`)
                .then(resp => resp.json())
                .then(data => {
                    MENU = data.filter(row => row['åç§°'] && (!row['æ˜¯å¦ä¸Šæ¶'] || row['æ˜¯å¦ä¸Šæ¶'] !== 'N'));
                    buildCategorySections();
                });
        }
        function buildCategorySections() {
            const cats = {};
            MENU.forEach(item => {
                const cat = (item['åˆ†ç±»']||'æœªåˆ†ç±»').trim();
                if (!cats[cat]) cats[cat]=[];
                cats[cat].push(item);
            });
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.entries(cats).forEach(([cat, items])=>{
                main.innerHTML += `
                <div class="category-block">
                    <div class="category-title">${catIcon(cat)} ${cat}</div>
                    <div class="goods-list">
                        ${items.map((item,idx)=>goodsCardHtml(item, idx)).join('')}
                    </div>
                </div>
                `;
            });
        }
        function catIcon(cat){
            if(cat.match(/food|é£Ÿç‰©/i)) return 'ğŸš';
            if(cat.match(/drink|é¥®æ–™/i)) return 'ğŸ¥¤';
            if(cat.match(/dessert|ç”œå“/i)) return 'ğŸ°';
            if(cat.match(/snack|å°åƒ/i)) return 'ğŸ¢';
            return 'ğŸ½ï¸';
        }
        function goodsCardHtml(item, idx){
            let tag = item['æ ‡ç­¾(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                           tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            return `
            <div class="goods-card" onclick="openItemModal('${encodeURIComponent(JSON.stringify(item))}')">
                <img class="goods-img" src="${item['å›¾ç‰‡_URL']||''}" alt="${item['åç§°']}">
                <div class="goods-title">
                    ${item['åç§°']}
                    ${tag?`<span class="${tagClass}">${tag}</span>`:""}
                </div>
                ${item['å¤‡æ³¨']?`<div class="goods-desc">${item['å¤‡æ³¨']}</div>`:""}
            </div>
            `;
        }
        // --- å•†å“è¯¦æƒ…å¼¹çª— ---
        let modalItem = null;
        let modalSpec = '';
        let modalPrice = 0;
        let modalQty = 1;
        function openItemModal(itemStr){
            modalItem = JSON.parse(decodeURIComponent(itemStr));
            modalSpec = '';
            modalPrice = 0;
            modalQty = 1;
            document.getElementById('item-modal-img').src = modalItem['å›¾ç‰‡_URL']||'';
            document.getElementById('item-modal-title').innerText = modalItem['åç§°'];
            let tag = modalItem['æ ‡ç­¾(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                        tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            document.getElementById('item-modal-tag').innerHTML = tag?`<span class="${tagClass}">${tag}</span>`:"";
            document.getElementById('item-modal-desc').innerText = modalItem['å¤‡æ³¨']||'';
            // æ¸²æŸ“è§„æ ¼æŒ‰é’®
            let specs = [];
            SPEC_NAMES.forEach(spec => {
                if (modalItem[spec] && modalItem[spec].trim()) {
                    specs.push({ spec, price: modalItem[spec].trim() });
                }
            });
            let specBtns = specs.map((s,i)=>`
                <button class="item-spec-btn${i===0?' selected':''}" onclick="selectModalSpec('${s.spec}','${s.price}',this);return false;">
                    ${s.spec}<span class="goods-price">ï¿¥${s.price}</span>
                </button>
            `).join('');
            document.getElementById('item-modal-specs').innerHTML = specBtns;
            if(specs.length){
                modalSpec = specs[0].spec; modalPrice = Number(specs[0].price);
            } else {
                modalSpec = ''; modalPrice=0;
            }
            document.getElementById('item-modal-qty-val').innerText = modalQty;
            document.getElementById('item-modal').style.display='flex';
        }
        function closeItemModal(){
            document.getElementById('item-modal').style.display='none';
        }
        function selectModalSpec(spec, price, btn){
            modalSpec = spec; modalPrice = Number(price);
            document.querySelectorAll('.item-spec-btn').forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        function changeModalQty(delta){
            modalQty+=delta;
            if(modalQty<1) modalQty=1;
            document.getElementById('item-modal-qty-val').innerText = modalQty;
        }
        function addModalToCart(){
            if (!modalSpec) {
                alert("è¯·é€‰æ‹©è§„æ ¼");
                return;
            }
            let idx = cart.findIndex(c => c.id === modalItem.id && c.spec === modalSpec);
            if (idx >= 0) {
                cart[idx].qty += modalQty;
            } else {
                cart.push({
                    id: modalItem.id,
                    name: modalItem['åç§°'],
                    img: modalItem['å›¾ç‰‡_URL'],
                    tag: modalItem['æ ‡ç­¾(tag)'],
                    spec: modalSpec,
                    price: Number(modalPrice),
                    qty: modalQty
                });
            }
            updateCartBadge();
            closeItemModal();
            showCartTip();
        }
        // --- è´­ç‰©è½¦æ ¸å¿ƒ ---
        function updateCartBadge() {
            let n = cart.reduce((s,c)=>s+c.qty,0);
            let badge = document.getElementById('cart-count');
            if (n>0) {
                badge.innerText = n;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        function showCartTip() {
            let badge = document.getElementById('cart-count');
            badge.animate([
                {transform:'scale(1.3)',background:'#ffb940'},
                {transform:'scale(1)',background:'#e91e63'}
            ],{duration:300});
        }
        function showCartModal() {
            renderCartList();
            renderAddressSelect();
            document.getElementById('cart-modal').style.display='flex';
        }
        function closeCartModal(){
            document.getElementById('cart-modal').style.display='none';
        }
        function renderCartList() {
            let list = document.getElementById('cart-list');
            if (cart.length === 0) {
                list.innerHTML = `<div style="text-align:center;color:#888;margin:24px 0;">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>`;
                document.getElementById('cart-total').innerText = 0;
                return;
            }
            list.innerHTML = cart.map((c,i)=>`
                <div class="cart-item">
                    <img src="${c.img}" class="cart-item-img">
                    <div style="flex:1">
                        <div class="cart-item-name">${c.name}
                            ${c.tag?`<span class="badge">${c.tag}</span>`:""}
                        </div>
                        <div class="cart-spec">${c.spec}</div>
                        <div class="cart-price">ï¿¥${c.price} Ã— ${c.qty}</div>
                    </div>
                    <div class="cart-qty-ctrl">
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},-1)">-</button>
                        <span>${c.qty}</span>
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},1)">+</button>
                        <button class="cart-del-btn" onclick="removeFromCart(${i})">åˆ </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cart-total').innerText = cart.reduce((s,c)=>s+c.price*c.qty,0);
        }
        function changeCartQty(idx,delta){
            cart[idx].qty+=delta;
            if(cart[idx].qty<=0) cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        function removeFromCart(idx){
            cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        // --- åœ°å€ç®¡ç† ---
        function renderAddressList(){
            let addrs = JSON.parse(localStorage.getItem('batman_addr_list')||'[]');
            let list = addrs.map((addr,idx)=>`
              <div class="addr-row">
                <span style="flex:1;word-break:break-all;">${addr}</span>
                <button class="addr-del" onclick="delAddress(${idx})">åˆ é™¤</button>
              </div>
            `).join('');
            document.getElementById('address-list').innerHTML = list || '<div style="color:#aaa;">æš‚æ— åœ°å€</div>';
        }
        function addAddress(e){
            e.preventDefault();
            let val = e.target.address.value.trim();
            if(!val) return;
            let addrs = JSON.parse(localStorage.getItem('batman_addr_list')||'[]');
            addrs.push(val);
            localStorage.setItem('batman_addr_list', JSON.stringify(addrs));
            e.target.reset();
            renderAddressList();
        }
        function delAddress(idx){
            let addrs = JSON.parse(localStorage.getItem('batman_addr_list')||'[]');
            addrs.splice(idx,1);
            localStorage.setItem('batman_addr_list', JSON.stringify(addrs));
            renderAddressList();
        }
        function renderAddressSelect(){
            let sel = document.getElementById('address-select');
            if(!sel) return;
            let addrs = JSON.parse(localStorage.getItem('batman_addr_list')||'[]');
            if(addrs.length === 0){
                sel.innerHTML = `<option value="">è¯·å…ˆåœ¨â€œæˆ‘â€é¡µé¢æ·»åŠ åœ°å€</option>`;
                sel.disabled = true;
            } else {
                sel.innerHTML = addrs.map(a=>`<option>${a}</option>`).join('');
                sel.disabled = false;
            }
        }
        // --- æäº¤è´­ç‰©è½¦è®¢å• ---
        async function submitCartOrder(e) {
            e.preventDefault();
            const user = window.telegramUser;
            if (!user) {
                alert("è¯·åœ¨ Telegram å†…éƒ¨æ‰“å¼€æœ¬é¡µé¢");
                return;
            }
            if(cart.length===0){
                alert("è´­ç‰©è½¦æ˜¯ç©ºçš„");
                return;
            }
            const raw = localStorage.getItem('batman_user_info');
            if(!raw){
                document.getElementById('cart-user-tips').innerText = "è¯·å…ˆåœ¨â€œæˆ‘â€é¡µé¢å¡«å†™å§“åå’Œç”µè¯";
                document.getElementById('cart-user-tips').style.display = '';
                return;
            }
            document.getElementById('cart-user-tips').style.display = 'none';
            const userInfo = JSON.parse(raw);
            const formData = Object.fromEntries(new FormData(e.target));
            let payload = {
                ...userInfo,
                address: formData.address||'',
                note: formData.note||'',
                telegram_id: user.id,
                telegram_name: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                items: cart
            };
            let btn = e.target.querySelector('.cart-order-btn');
            btn.disabled=true; btn.innerText="æäº¤ä¸­...";
            // è¿™é‡Œå»ºè®®ä»ç„¶é€šè¿‡ä½ è‡ªå·±åç«¯è½¬å­˜ Google Sheetï¼Œæˆ– Apps Script doPost å†™å…¥
            const resp = await fetch("https://batmanshop.onrender.com/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            btn.disabled=false; btn.innerText="æäº¤è®¢å•";
            if (resp.ok) {
                alert("ä¸‹å•æˆåŠŸï¼");
                cart = []; updateCartBadge(); closeCartModal();
            } else {
                alert("æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
            }
        }
        // --- è®¢å•å†å²é¡µ ---
        async function loadOrderHistory(){
            const user = window.telegramUser;
            if(!user) {
              document.getElementById('orders-list').innerHTML = '<div style="color:#e55;">è¯·åœ¨ Telegram æ‰“å¼€æœ¬å°ç¨‹åº</div>';
              return;
            }
            document.getElementById('orders-list').innerHTML = '<div style="color:#aaa;text-align:center;margin-top:40px;">æ­£åœ¨åŠ è½½è®¢å•â€¦</div>';
            try {
              let resp = await fetch(`${SHEET_API}?sheet=orders&telegram_id=${user.id}`);
              let orders = await resp.json();
              if(!orders.length) {
                document.getElementById('orders-list').innerHTML = '<div style="color:#aaa;text-align:center;margin-top:50px;">æš‚æ— å†å²è®¢å•</div>';
                return;
              }
              document.getElementById('orders-list').innerHTML = orders.map(renderOrderCard).join('');
            } catch(e){
              document.getElementById('orders-list').innerHTML = '<div style="color:#e55;">è®¢å•è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>';
            }
        }
        function renderOrderCard(order){
            return `<div class="order-card">
              <div class="order-header">
                <span>è®¢å•å·ï¼š${order['è®¢å•å·']||'-'}</span>
                <span class="order-status">${order['çŠ¶æ€']||''}</span>
              </div>
              <div class="order-addr">${order['åœ°å€']||''}</div>
              <div class="order-items">
                ${order.items ? order.items.map(x=>
                    `${x.name}${x.spec?'('+x.spec+')':''} Ã—${x.qty} <span style="float:right;">ï¿¥${x.price*x.qty}</span>`
                  ).join('<br>') : ''}
              </div>
              ${order['å¤‡æ³¨']?`<div class="order-note">å¤‡æ³¨ï¼š${order['å¤‡æ³¨']}</div>`:""}
              <div style="color:#888;font-size:.92em;margin-top:5px;">${order['åˆ›å»ºæ—¶é—´']||''}</div>
              <div style="font-weight:600;font-size:1.05em;margin-top:2px;">æ€»è®¡ï¼šï¿¥${order['æ€»ä»·']||'0'}</div>
            </div>`;
        }
        // --- åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢ ---
        function switchPage(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            let navOrder={'home':0,'orders':1,'cart':2,'me':3};
            if(p!=="cart"){ 
                document.querySelectorAll('.nav-btn')[navOrder[p]].classList.add('active');
            }
            if(p==="orders") loadOrderHistory();
        }
        switchPage('home');
        // --- ç”¨æˆ·ä¿¡æ¯ä¿å­˜å’Œè¯»å– ---
        function saveUserInfo(e){
            e.preventDefault();
            const d = Object.fromEntries(new FormData(e.target));
            localStorage.setItem('batman_user_info', JSON.stringify(d));
            document.getElementById('user-info-saved').style.display = '';
            setTimeout(()=>{ document.getElementById('user-info-saved').style.display='none'; }, 1200);
        }
        function loadUserInfo(){
            let raw = localStorage.getItem('batman_user_info');
            if(raw){
                let d = JSON.parse(raw);
                document.querySelectorAll("#userInfoForm input[name=name]").forEach(x=>x.value=d.name||'');
                document.querySelectorAll("#userInfoForm input[name=phone]").forEach(x=>x.value=d.phone||'');
            }
        }
        // --- ç”¨æˆ·Telegramèµ„æ–™å¡«å…… ---
        function fillMeInfo(){
            if(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user){
                let u = Telegram.WebApp.initDataUnsafe.user;
                document.getElementById('me-nick').innerText = u.first_name + (u.last_name?(' '+u.last_name):'');
                document.getElementById('me-uid').innerText = "ID: " + u.id + (u.username ? (" @" + u.username) : "");
                window.telegramUser = u;
            }else{
                document.getElementById('me-nick').innerText = '';
                document.getElementById('me-uid').innerText = '';
                window.telegramUser = null;
            }
        }
        // --- å¤§å›¾æŸ¥çœ‹å™¨ ---
        function showImgViewer(src){
            let v = document.getElementById('img-viewer');
            document.getElementById('img-viewer-pic').src = src;
            v.style.display = 'flex';
            v.onclick = ()=>{ v.style.display='none'; }
        }
        // --- åˆå§‹åŒ– ---
        window.onload = function(){
            fillMeInfo();
            loadMenuFromSheet();
            loadUserInfo();
            renderAddressList();
        }
    </script>
</body>
</html>
