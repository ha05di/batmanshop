<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Batman1788 å•†åŸ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin:0; background:#f3f5f8; font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif; }
        .ad-banner { width:100%; height:120px; background:#1b1c1e; border-radius:0 0 20px 20px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
        .ad-banner img { width:98%; height:110px; object-fit:cover; border-radius:18px; box-shadow:0 2px 10px #0002; }
        .main { padding:8px 10px 70px 10px; max-width:520px; margin:0 auto; }
        .category-block { margin-bottom:18px; }
        .category-title { font-size:1.13em; font-weight:700; margin:14px 0 7px 5px; display:flex; align-items:center; gap:7px;}
        .goods-list {
    display: flex;
    flex-direction: row;    /* æ¨ªå‘æ’åˆ— */
    gap: 14px;              /* å¡ç‰‡é—´è· */
    overflow-x: auto;       /* æ¨ªå‘æ»šåŠ¨ */
    padding-bottom: 8px;    /* å¢åŠ æ»šåŠ¨æ¡å’Œå†…å®¹è·ç¦» */
    scrollbar-width: thin;  /* ä¼˜åŒ–æ»šåŠ¨æ¡ */
    /* å¯é€‰ï¼šè®©æ»šåŠ¨æ¡ä¸é‚£ä¹ˆæ˜æ˜¾ï¼ˆç¾è§‚ç”¨ï¼‰ */
    /* scrollbar-color: #ddd #fff; */
}
        .goods-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 2px 8px #0001;
    padding: 13px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    min-width: 130px;   /* å¡ç‰‡æœ€å°å®½åº¦ï¼Œä¿è¯æ¨ªæ’ */
    max-width: 150px;
    flex: 0 0 auto;     /* ä¸è‡ªåŠ¨æ¢è¡Œ */
}
        .goods-img { width:66px; height:66px; object-fit:cover; border-radius:11px; border:1px solid #eee; background:#fafbfc; margin-bottom:8px; }
        .goods-title { font-size:1.03em; font-weight:600; margin-bottom:2px; text-align:center;}
        .badge { display:inline-block; background:#ffb940; color:#543; font-size:.93em; border-radius:7px; padding:1.5px 10px; margin-left:6px; margin-bottom:3px;}
        .tag-indica { background:#b6a7f5; color:#333; }
        .tag-sativa { background:#ffbb66; color:#222; }
        .goods-specs { margin:5px 0 0 0; text-align:center; }
        .goods-spec-btn { margin:3px 4px 0 0; border:none; border-radius:7px; background:#eee; padding:2px 10px; font-size:.99em; cursor:pointer; }
        .goods-spec-btn.selected { background:#1a73e8; color:#fff; }
        .goods-price { color:#e91e63; font-size:.97em; font-weight:600; margin-left:3px;}
        .order-btn { background:#222; color:#fff; border:none; border-radius:8px; padding:6px 15px; font-size:.98em; margin-top:7px; cursor:pointer; }
        .goods-desc { color:#888; font-size:.91em; margin:2px 0 0 0;text-align:center;}
        .nav-bar { position:fixed; left:0; right:0; bottom:0; height:55px; background:#fff; border-top:1px solid #eee; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -2px 10px #0001; z-index:10;}
        .nav-btn { flex:1; text-align:center; color:#666; font-size:.98em; padding-top:5px;}
        .nav-btn.active { color:#1a73e8; font-weight:600;}
        .nav-btn svg { display:block; margin:0 auto 2px auto;}
        /* é¡µé¢åˆ‡æ¢éšè— */
        .page { display:none; }
        .page.active { display:block; }
        @media (max-width:600px) {
            .main {padding-bottom:90px;}
            .ad-banner {height:90px;}
            .ad-banner img {height:80px;}
            .goods-img { width:52px;height:52px;}
            .goods-card { width:48vw; min-width:132px;}
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¹¿å‘Šï¼Œå¯æ›¿æ¢ä½ çš„bannerå›¾ -->
    <div class="ad-banner">
        <img src="https://raw.githubusercontent.com/ha05di/batman1788Menu/main/banner/coffee-banner.jpg" alt="å¹¿å‘Š">
    </div>
    <div class="main">
        <!-- é¦–é¡µï¼šåˆ†åŒºå•†å“åˆ—è¡¨ -->
        <div class="page" id="page-home">
            <div id="main-content"></div>
        </div>
        <!-- è®¢å•åˆ—è¡¨ -->
        <div class="page" id="page-orders">
            <div style="text-align:center; color:#888; margin-top:40px;">æš‚æœªå®ç°è®¢å•å†å²ï¼Œå¯åç»­å¯¹æ¥</div>
        </div>
        <!-- æˆ‘çš„ -->
        <div class="page" id="page-me">
            <div style="text-align:center; color:#888; margin-top:40px;">
                <div id="telegram-info"></div>
            </div>
        </div>
    </div>
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="switchPage('home')">
            <svg width="22" height="22" fill="none"><rect x="3" y="8" width="16" height="11" rx="3" fill="currentColor"/><path d="M3 10L11 4l8 6" stroke="#1a73e8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            é¦–é¡µ
        </div>
        <div class="nav-btn" onclick="switchPage('orders')">
            <svg width="22" height="22" fill="none"><rect x="3" y="4" width="16" height="14" rx="3" fill="currentColor"/><path d="M7 8h8M7 12h5" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/></svg>
            è®¢å•
        </div>
        <div class="nav-btn" onclick="switchPage('me')">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="9" r="4" fill="currentColor"/><rect x="5" y="15" width="12" height="5" rx="3" fill="currentColor"/></svg>
            æˆ‘çš„
        </div>
    </div>
    <!-- ä¸‹å•å¼¹çª— -->
    <div id="order-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;background:#0005;align-items:center;justify-content:center;">
        <form id="orderForm" style="background:#fff;max-width:340px;width:92%;margin:0 auto;padding:2em 1.4em;border-radius:16px;box-shadow:0 8px 32px #0003;display:flex;flex-direction:column;gap:12px;" onsubmit="submitOrder(event)">
            <div style="text-align:center;font-size:1.1em;font-weight:600" id="modal-title"></div>
            <div style="display:flex;gap:12px;align-items:center;justify-content:center;">
                <img id="modal-img" src="" style="width:54px;height:54px;border-radius:10px;">
                <span id="modal-spec"></span>
            </div>
            <input type="hidden" name="item">
            <input type="hidden" name="img">
            <input type="hidden" name="tag">
            <input type="hidden" name="spec">
            <input type="hidden" name="price">
            <label>å§“åï¼š<input name="name" required placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"></label>
            <label>ç”µè¯ï¼š<input name="phone" required placeholder="æ‰‹æœºå·"></label>
            <label>æ•°é‡ï¼š<input name="qty" type="number" value="1" min="1"></label>
            <label>å¤‡æ³¨ï¼š<input name="note" placeholder="å¯é€‰"></label>
            <button type="submit" id="order-submit-btn">æäº¤è®¢å•</button>
            <button type="button" onclick="closeModal()" style="background:#eee;color:#444;margin-top:-6px;">å–æ¶ˆ</button>
        </form>
    </div>
    <script>
        // Sheet èœå•æ‹‰å–ä¸åˆ†ç±»åˆ†åŒºæ¸²æŸ“
        let MENU = [];
        let SPEC_NAMES = ["Q", "H", "OZ"]; // å¯ä»¥è‡ªå®šä¹‰
        function loadMenuFromSheet() {
            const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs/export?format=csv&gid=0";
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    MENU = results.data.filter(row => row['åç§°'] && row['æ˜¯å¦ä¸Šæ¶'] !== 'N');
                    buildCategorySections();
                }
            });
        }
        function buildCategorySections() {
            const cats = {};
            MENU.forEach(item => {
                const cat = (item['åˆ†ç±»']||'æœªåˆ†ç±»').trim();
                if (!cats[cat]) cats[cat]=[];
                cats[cat].push(item);
            });
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.entries(cats).forEach(([cat, items])=>{
                main.innerHTML += `
                <div class="category-block">
                    <div class="category-title">${catIcon(cat)} ${cat}</div>
                    <div class="goods-list">
                        ${items.map((item,idx)=>goodsCardHtml(item, idx)).join('')}
                    </div>
                </div>
                `;
            });
        }
        function catIcon(cat){
            if(cat.match(/food|é£Ÿç‰©/i)) return 'ğŸš';
            if(cat.match(/drink|é¥®æ–™/i)) return 'ğŸ¥¤';
            if(cat.match(/dessert|ç”œå“/i)) return 'ğŸ°';
            if(cat.match(/snack|å°åƒ/i)) return 'ğŸ¢';
            return 'ğŸ½ï¸';
        }
        function goodsCardHtml(item, idx){
            let specs = [];
            SPEC_NAMES.forEach(spec => {
                if (item[spec] && item[spec].trim()) {
                    specs.push({ spec, price: item[spec].trim() });
                }
            });
            let tag = item['æ ‡ç­¾(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                           tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            // å¤šè§„æ ¼æŒ‰é’®
            let specBtns = specs.map((s,i)=>`
                <button class="goods-spec-btn" onclick="openOrderModal('${encodeURIComponent(JSON.stringify(item))}','${s.spec}','${s.price}');return false;">
                    ${s.spec}<span class="goods-price">ï¿¥${s.price}</span>
                </button>
            `).join('');
            return `
            <div class="goods-card">
                <img class="goods-img" src="${item['å›¾ç‰‡_URL']||''}" alt="${item['åç§°']}">
                <div class="goods-title">
                    ${item['åç§°']}
                    ${tag?`<span class="${tagClass}">${tag}</span>`:""}
                </div>
                ${item['å¤‡æ³¨']?`<div class="goods-desc">${item['å¤‡æ³¨']}</div>`:""}
                <div class="goods-specs">${specBtns}</div>
            </div>
            `;
        }
        // åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢
        function switchPage(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            let navOrder={'home':0,'orders':1,'me':2};
            document.querySelectorAll('.nav-btn')[navOrder[p]].classList.add('active');
        }
        switchPage('home');

        // ä¸‹å•å¼¹çª—é€»è¾‘
        function openOrderModal(itemStr,spec,price){
            const item = JSON.parse(decodeURIComponent(itemStr));
            document.getElementById('modal-title').innerText = item['åç§°'];
            document.getElementById('modal-img').src = item['å›¾ç‰‡_URL']||'';
            document.getElementById('modal-spec').innerHTML = `<span class="badge">${spec}</span> <span class="goods-price">ï¿¥${price}</span>`;
            // å¡«å……éšè—å­—æ®µ
            let f = document.getElementById('orderForm');
            f.item.value = item['åç§°'];
            f.img.value = item['å›¾ç‰‡_URL']||'';
            f.tag.value = item['æ ‡ç­¾(tag)']||'';
            f.spec.value = spec;
            f.price.value = price;
            document.getElementById('order-modal').style.display='flex';
        }
        function closeModal(){
            document.getElementById('order-modal').style.display='none';
        }

        // è®¢å•æäº¤
        async function submitOrder(e){
            e.preventDefault();
            const user = window.telegramUser;
            if (!user) {
                alert("è¯·åœ¨ Telegram å†…éƒ¨æ‰“å¼€æœ¬é¡µé¢");
                return;
            }
            let formData = Object.fromEntries(new FormData(e.target));
            formData.telegram_id = user.id;
            formData.telegram_name = user.username || '';
            formData.first_name = user.first_name || '';
            formData.last_name = user.last_name || '';
            document.getElementById('order-submit-btn').disabled=true;
            document.getElementById('order-submit-btn').innerText='æäº¤ä¸­...';
            const resp = await fetch("https://batmanshop.onrender.com/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });
            document.getElementById('order-submit-btn').disabled=false;
            document.getElementById('order-submit-btn').innerText='æäº¤è®¢å•';
            if (resp.ok) {
                alert("ä¸‹å•æˆåŠŸï¼");
                closeModal();
            } else {
                alert("æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
            }
        }

        // Telegramç™»å½•ä¿¡æ¯
        window.onload = function () {
            loadMenuFromSheet();
            if (window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                window.telegramUser = user;
                document.getElementById('telegram-info').innerHTML =
                    `<b>${user.first_name || ''} ${user.last_name || ''}</b> <span style="color:#888">(ID: ${user.id})</span><br>${user.username ? '@'+user.username : ''}`;
            } else {
                document.getElementById('telegram-info').innerHTML =
                    `<span style="color:#e55">è¯·åœ¨ Telegram å†…éƒ¨æ‰“å¼€ï¼ˆç‚¹å‡»èœå•/æŒ‰é’®è¿›å…¥ï¼‰</span>`;
            }
        }
    </script>
</body>
</html>
