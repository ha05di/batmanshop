<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Batman1788 商城</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin:0; background:#f3f5f8; font-family:'Segoe UI','Microsoft YaHei',Arial,sans-serif; }
        .ad-banner { width:100%; height:120px; background:#1b1c1e; border-radius:0 0 20px 20px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
        .ad-banner img { width:98%; height:110px; object-fit:cover; border-radius:18px; box-shadow:0 2px 10px #0002; }
        .main { padding:8px 10px 70px 10px; max-width:520px; margin:0 auto; }
        .category-block { margin-bottom:18px; }
        .category-title { font-size:1.13em; font-weight:700; margin:14px 0 7px 5px; display:flex; align-items:center; gap:7px;}
        .goods-list {
    display: flex;
    flex-direction: row;
    gap: 14px;
    overflow-x: auto;
    padding-bottom: 8px;
    scrollbar-width: none;                /* Firefox 隐藏滚动条 */
    -webkit-overflow-scrolling: touch;    /* iOS 惯性滑动 */
}
        .goods-list::-webkit-scrollbar {
    display: none;                        /* Chrome/Safari/Android 隐藏滚动条 */
}
        .goods-card { background:#fff; border-radius:15px; box-shadow:0 2px 8px #0001; padding:13px 12px; display:flex; flex-direction:column; align-items:center; position:relative; min-width:130px; max-width:150px; flex:0 0 auto; cursor:pointer; transition:box-shadow .18s;}
        .goods-card:active { box-shadow:0 4px 16px #0002;}
        .goods-img { width:66px; height:66px; object-fit:cover; border-radius:11px; border:1px solid #eee; background:#fafbfc; margin-bottom:8px; }
        .goods-title { font-size:1.03em; font-weight:600; margin-bottom:2px; text-align:center;}
        .badge { display:inline-block; background:#ffb940; color:#543; font-size:.93em; border-radius:7px; padding:1.5px 10px; margin-left:6px; margin-bottom:3px;}
        .tag-indica { background:#b6a7f5; color:#333; }
        .tag-sativa { background:#ffbb66; color:#222; }
        .goods-specs { margin:5px 0 0 0; text-align:center; }
        .goods-desc { color:#888; font-size:.91em; margin:2px 0 0 0;text-align:center;}
        .nav-bar { position:fixed; left:0; right:0; bottom:0; height:55px; background:#fff; border-top:1px solid #eee; display:flex; justify-content:space-around; align-items:center; box-shadow:0 -2px 10px #0001; z-index:10;}
        .nav-btn { flex:1; text-align:center; color:#666; font-size:.98em; padding-top:5px; position:relative;}
        .nav-btn.active { color:#1a73e8; font-weight:600;}
        .nav-btn svg { display:block; margin:0 auto 2px auto;}
        .cart-count-dot { display:inline-block; position:absolute; right:28%; top:5px; background:#e91e63; color:#fff; border-radius:50%; min-width:18px; font-size:.92em; font-weight:700; padding:2px 5px; }
        .page { display:none; }
        .page.active { display:block; }
        /* 商品详情弹窗 */
        #item-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; z-index:999; background:#0005; align-items:center; justify-content:center;}
        #item-panel { background:#fff; border-radius:18px; max-width:410px; width:97%; margin:0 auto; padding:1.3em 1.1em 1.2em 1.1em; box-shadow:0 8px 32px #0003; display:flex; flex-direction:column; gap:10px; max-height:92vh; overflow:auto;}
        .item-modal-img { width:80px;height:80px; border-radius:12px; object-fit:cover; margin:0 auto 5px auto; cursor:pointer;}
        .item-modal-title { font-size:1.12em; font-weight:700; text-align:center;}
        .item-modal-tag { margin-left:8px; }
        .item-modal-desc { color:#888; font-size:.96em; margin-bottom:.6em; text-align:center;}
        .item-modal-specs { text-align:center; margin:0 0 9px 0;}
        .item-spec-btn { border:none; border-radius:7px; background:#eee; padding:4px 14px; font-size:.99em; cursor:pointer; margin:0 5px 5px 0;}
        .item-spec-btn.selected { background:#1a73e8; color:#fff; }
        .item-modal-qty { display:flex;align-items:center;justify-content:center;gap:12px;margin:8px 0;}
        .item-qty-btn { background:#eee; border:none; font-size:1.16em; width:26px; height:26px; border-radius:6px; cursor:pointer; }
        .item-modal-footer { display:flex; flex-direction:column; align-items:center; gap:6px;}
        .item-modal-cart-btn { background:#f78031; color:#fff; border:none; border-radius:9px; font-size:1.05em; padding:10px 0; width:100%; }
        .item-modal-close-btn { background:#eee; color:#444; border:none; border-radius:7px; margin-top:-2px; padding:7px 0; width:100%; }
        /* 购物车弹窗 */
        #cart-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; z-index:999; background:#0005; align-items:center; justify-content:center;}
        #cart-panel { background:#fff; border-radius:18px; max-width:410px; width:97%; margin:0 auto; padding:1.4em 1.1em 1.2em 1.1em; box-shadow:0 8px 32px #0003; display:flex; flex-direction:column; gap:10px; max-height:92vh; overflow:auto;}
        .cart-title { font-weight:700; font-size:1.13em; text-align:center; margin-bottom:.7em;}
        .cart-item { display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:7px 0;}
        .cart-item-img { width:42px; height:42px; border-radius:7px; object-fit:cover;}
        .cart-item-name { font-weight:500; }
        .cart-spec { color:#888; font-size:.93em; margin-left:3px;}
        .cart-qty-ctrl { display:flex; align-items:center; gap:6px;}
        .cart-qty-btn { background:#eee; border:none; font-size:1.1em; width:24px; height:24px; border-radius:5px; cursor:pointer; }
        .cart-del-btn { background:#ff9c9c; border:none; border-radius:6px; color:#fff; font-size:.93em; margin-left:7px; padding:1px 9px; cursor:pointer;}
        .cart-footer { margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:8px;}
        .cart-total { font-weight:600; font-size:1.07em;}
        #cartForm label {display:block; margin:10px 0 2px 0;}
        #cartForm input {width:100%; padding:6px; border-radius:5px; border:1px solid #ccc;}
        .cart-order-btn { background:#1a73e8; color:#fff; border:none; border-radius:9px; font-size:1.05em; padding:9px 0; width:100%; }
        .cart-close-btn { background:#eee; color:#444; border:none; border-radius:7px; margin-top:-2px; padding:6px 0; width:100%; }
        @media (max-width:600px) {
            .main {padding-bottom:90px;}
            .ad-banner {height:90px;}
            .ad-banner img {height:80px;}
            .goods-img { width:52px;height:52px;}
            .goods-card { width:48vw; min-width:132px;}
            #item-panel {padding:1em .5em;}
            #cart-panel {padding:1em .5em;}
        }
        /* 大图查看器 */
        #img-viewer { display:none; position:fixed;z-index:2000;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.97);align-items:center;justify-content:center;}
        #img-viewer-pic { max-width:95vw;max-height:85vh;border-radius:20px;box-shadow:0 4px 40px #0007;transition:all .2s;}
    </style>
</head>
<body>
    <!-- 顶部广告 -->
    <div class="ad-banner">
        <img src="https://raw.githubusercontent.com/ha05di/batman1788Menu/main/banner.png" alt="广告">
    </div>
    <div class="main">
        <!-- 首页：分区商品列表 -->
        <div class="page" id="page-home">
            <div id="main-content"></div>
        </div>
        <!-- 订单列表 -->
        <div class="page" id="page-orders">
            <div style="text-align:center; color:#888; margin-top:40px;">暂未实现订单历史，可后续对接</div>
        </div>
        <!-- 我的 -->
        <div class="page" id="page-me">
            <div style="max-width:320px;margin:0 auto;">
                <div style="font-size:1.07em;font-weight:600;margin:12px 0 8px 0;">下单人信息</div>
                <form id="userInfoForm" onsubmit="saveUserInfo(event)">
                    <label>姓名：<input name="name" required placeholder="请输入您的姓名"></label>
                    <label>电话：<input name="phone" required placeholder="手机号"></label>
                    <button type="submit" class="cart-order-btn" style="margin-top:13px;">保存信息</button>
                </form>
                <div id="user-info-saved" style="color:#4caf50;font-weight:500;display:none;margin-top:8px;">已保存，下单自动带入！</div>
                <div id="telegram-info" style="margin-top:23px;"></div>
            </div>
        </div>
    </div>
    <!-- 底部导航栏，四栏 -->
    <div class="nav-bar">
        <div class="nav-btn active" onclick="switchPage('home')">
            <svg width="22" height="22" fill="none"><rect x="3" y="8" width="16" height="11" rx="3" fill="currentColor"/><path d="M3 10L11 4l8 6" stroke="#1a73e8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            首页
        </div>
        <div class="nav-btn" onclick="switchPage('orders')">
            <svg width="22" height="22" fill="none"><rect x="3" y="4" width="16" height="14" rx="3" fill="currentColor"/><path d="M7 8h8M7 12h5" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/></svg>
            订单
        </div>
        <div class="nav-btn" onclick="showCartModal()">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="11" r="8" fill="currentColor"/><path d="M7 17h8M8 17v2h6v-2" stroke="#1a73e8" stroke-width="2"/><circle cx="15" cy="9" r="1" fill="#fff"/><circle cx="11" cy="9" r="1" fill="#fff"/><circle cx="7" cy="9" r="1" fill="#fff"/></svg>
            购物车
            <span id="cart-count" class="cart-count-dot" style="display:none"></span>
        </div>
        <div class="nav-btn" onclick="switchPage('me')">
            <svg width="22" height="22" fill="none"><circle cx="11" cy="9" r="4" fill="currentColor"/><rect x="5" y="15" width="12" height="5" rx="3" fill="currentColor"/></svg>
            我
        </div>
    </div>
    <!-- 商品详情弹窗 -->
    <div id="item-modal">
        <div id="item-panel">
            <img id="item-modal-img" class="item-modal-img" src="" onclick="showImgViewer(this.src)">
            <div class="item-modal-title" id="item-modal-title"></div>
            <div id="item-modal-tag"></div>
            <div class="item-modal-desc" id="item-modal-desc"></div>
            <div class="item-modal-specs" id="item-modal-specs"></div>
            <div class="item-modal-qty">
                <button class="item-qty-btn" onclick="changeModalQty(-1)">-</button>
                <span id="item-modal-qty-val">1</span>
                <button class="item-qty-btn" onclick="changeModalQty(1)">+</button>
            </div>
            <div class="item-modal-footer">
                <button class="item-modal-cart-btn" onclick="addModalToCart()">加入购物车</button>
                <button class="item-modal-close-btn" onclick="closeItemModal()">关闭</button>
            </div>
        </div>
    </div>
    <!-- 购物车弹窗 -->
    <div id="cart-modal">
        <div id="cart-panel">
            <div class="cart-title">🛒 我的购物车</div>
            <div id="cart-list"></div>
            <div class="cart-footer">
                <div class="cart-total">总价：<span id="cart-total">0</span></div>
                <form id="cartForm" onsubmit="submitCartOrder(event)">
                    <label>备注：<input name="note" placeholder="可选"></label>
                    <button type="submit" class="cart-order-btn">提交订单</button>
                </form>
                <button type="button" class="cart-close-btn" onclick="closeCartModal()">关闭</button>
                <div id="cart-user-tips" style="color:#e55;font-size:.98em;margin-top:5px;display:none;"></div>
            </div>
        </div>
    </div>
    <!-- 大图全屏查看器 -->
    <div id="img-viewer" style="display:none;position:fixed;z-index:2000;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.97);align-items:center;justify-content:center;">
        <img id="img-viewer-pic" src="" style="max-width:95vw;max-height:85vh;border-radius:20px;box-shadow:0 4px 40px #0007;transition:all .2s;">
    </div>
    <script>
        // --- 全局数据 ---
        let MENU = [];
        let SPEC_NAMES = ["Q", "H", "OZ"];
        let cart = [];
        // --- Sheet 拉取与分类分区渲染 ---
        function loadMenuFromSheet() {
            const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs/export?format=csv&gid=0";
            Papa.parse(SHEET_CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    MENU = results.data.filter(row => row['名称'] && row['是否上架'] !== 'N');
                    buildCategorySections();
                }
            });
        }
        function buildCategorySections() {
            const cats = {};
            MENU.forEach(item => {
                const cat = (item['分类']||'未分类').trim();
                if (!cats[cat]) cats[cat]=[];
                cats[cat].push(item);
            });
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.entries(cats).forEach(([cat, items])=>{
                main.innerHTML += `
                <div class="category-block">
                    <div class="category-title">${catIcon(cat)} ${cat}</div>
                    <div class="goods-list">
                        ${items.map((item,idx)=>goodsCardHtml(item, idx)).join('')}
                    </div>
                </div>
                `;
            });
        }
        function catIcon(cat){
            if(cat.match(/food|食物/i)) return '🍚';
            if(cat.match(/drink|饮料/i)) return '🥤';
            if(cat.match(/dessert|甜品/i)) return '🍰';
            if(cat.match(/snack|小吃/i)) return '🍢';
            return '🍽️';
        }
        function goodsCardHtml(item, idx){
            let tag = item['标签(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                           tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            return `
            <div class="goods-card" onclick="openItemModal('${encodeURIComponent(JSON.stringify(item))}')">
                <img class="goods-img" src="${item['图片_URL']||''}" alt="${item['名称']}">
                <div class="goods-title">
                    ${item['名称']}
                    ${tag?`<span class="${tagClass}">${tag}</span>`:""}
                </div>
                ${item['备注']?`<div class="goods-desc">${item['备注']}</div>`:""}
            </div>
            `;
        }
        // --- 商品详情弹窗 ---
        let modalItem = null;
        let modalSpec = '';
        let modalPrice = 0;
        let modalQty = 1;
        function openItemModal(itemStr){
            modalItem = JSON.parse(decodeURIComponent(itemStr));
            modalSpec = '';
            modalPrice = 0;
            modalQty = 1;
            document.getElementById('item-modal-img').src = modalItem['图片_URL']||'';
            document.getElementById('item-modal-title').innerText = modalItem['名称'];
            let tag = modalItem['标签(tag)']||'';
            let tagClass = tag.toLowerCase().includes('indica') ? 'badge tag-indica' :
                        tag.toLowerCase().includes('sativa') ? 'badge tag-sativa' : 'badge';
            document.getElementById('item-modal-tag').innerHTML = tag?`<span class="${tagClass}">${tag}</span>`:"";
            document.getElementById('item-modal-desc').innerText = modalItem['备注']||'';
            // 渲染规格按钮
            let specs = [];
            SPEC_NAMES.forEach(spec => {
                if (modalItem[spec] && modalItem[spec].trim()) {
                    specs.push({ spec, price: modalItem[spec].trim() });
                }
            });
            let specBtns = specs.map((s,i)=>`
                <button class="item-spec-btn${i===0?' selected':''}" onclick="selectModalSpec('${s.spec}','${s.price}',this);return false;">
                    ${s.spec}<span class="goods-price">￥${s.price}</span>
                </button>
            `).join('');
            document.getElementById('item-modal-specs').innerHTML = specBtns;
            if(specs.length){
                modalSpec = specs[0].spec; modalPrice = Number(specs[0].price);
            } else {
                modalSpec = ''; modalPrice=0;
            }
            document.getElementById('item-modal-qty-val').innerText = modalQty;
            document.getElementById('item-modal').style.display='flex';
        }
        function closeItemModal(){
            document.getElementById('item-modal').style.display='none';
        }
        function selectModalSpec(spec, price, btn){
            modalSpec = spec; modalPrice = Number(price);
            document.querySelectorAll('.item-spec-btn').forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        function changeModalQty(delta){
            modalQty+=delta;
            if(modalQty<1) modalQty=1;
            document.getElementById('item-modal-qty-val').innerText = modalQty;
        }
        function addModalToCart(){
            if (!modalSpec) {
                alert("请选择规格");
                return;
            }
            let idx = cart.findIndex(c => c.id === modalItem.id && c.spec === modalSpec);
            if (idx >= 0) {
                cart[idx].qty += modalQty;
            } else {
                cart.push({
                    id: modalItem.id,
                    name: modalItem['名称'],
                    img: modalItem['图片_URL'],
                    tag: modalItem['标签(tag)'],
                    spec: modalSpec,
                    price: Number(modalPrice),
                    qty: modalQty
                });
            }
            updateCartBadge();
            closeItemModal();
            showCartTip();
        }
        // --- 购物车核心 ---
        function updateCartBadge() {
            let n = cart.reduce((s,c)=>s+c.qty,0);
            let badge = document.getElementById('cart-count');
            if (n>0) {
                badge.innerText = n;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        function showCartTip() {
            // 简单动画，加入购物车时提示
            let badge = document.getElementById('cart-count');
            badge.animate([
                {transform:'scale(1.3)',background:'#ffb940'},
                {transform:'scale(1)',background:'#e91e63'}
            ],{duration:300});
        }
        function showCartModal() {
            renderCartList();
            document.getElementById('cart-modal').style.display='flex';
        }
        function closeCartModal(){
            document.getElementById('cart-modal').style.display='none';
        }
        function renderCartList() {
            let list = document.getElementById('cart-list');
            if (cart.length === 0) {
                list.innerHTML = `<div style="text-align:center;color:#888;margin:24px 0;">购物车是空的</div>`;
                document.getElementById('cart-total').innerText = 0;
                return;
            }
            list.innerHTML = cart.map((c,i)=>`
                <div class="cart-item">
                    <img src="${c.img}" class="cart-item-img">
                    <div style="flex:1">
                        <div class="cart-item-name">${c.name}
                            ${c.tag?`<span class="badge">${c.tag}</span>`:""}
                        </div>
                        <div class="cart-spec">${c.spec}</div>
                        <div class="cart-price">￥${c.price} × ${c.qty}</div>
                    </div>
                    <div class="cart-qty-ctrl">
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},-1)">-</button>
                        <span>${c.qty}</span>
                        <button class="cart-qty-btn" onclick="changeCartQty(${i},1)">+</button>
                        <button class="cart-del-btn" onclick="removeFromCart(${i})">删</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cart-total').innerText = cart.reduce((s,c)=>s+c.price*c.qty,0);
        }
        function changeCartQty(idx,delta){
            cart[idx].qty+=delta;
            if(cart[idx].qty<=0) cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        function removeFromCart(idx){
            cart.splice(idx,1);
            renderCartList(); updateCartBadge();
        }
        // --- 提交购物车订单 ---
        async function submitCartOrder(e) {
            e.preventDefault();
            const user = window.telegramUser;
            if (!user) {
                alert("请在 Telegram 内部打开本页面");
                return;
            }
            if(cart.length===0){
                alert("购物车是空的");
                return;
            }
            // 取本地用户信息
            const raw = localStorage.getItem('batman_user_info');
            if(!raw){
                document.getElementById('cart-user-tips').innerText = "请先在“我”页面填写姓名和电话";
                document.getElementById('cart-user-tips').style.display = '';
                return;
            }
            document.getElementById('cart-user-tips').style.display = 'none';
            const userInfo = JSON.parse(raw);
            // 获取备注
            const formData = Object.fromEntries(new FormData(e.target));
            let payload = {
                ...userInfo,
                note: formData.note||'',
                telegram_id: user.id,
                telegram_name: user.username || '',
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                items: cart
            };
            let btn = e.target.querySelector('.cart-order-btn');
            btn.disabled=true; btn.innerText="提交中...";
            const resp = await fetch("https://batmanshop.onrender.com/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            btn.disabled=false; btn.innerText="提交订单";
            if (resp.ok) {
                alert("下单成功！");
                cart = []; updateCartBadge(); closeCartModal();
            } else {
                alert("提交失败，请稍后再试。");
            }
        }
        // --- 底部导航栏切换 ---
        function switchPage(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            let navOrder={'home':0,'orders':1,'cart':2,'me':3};
            if(p!=="cart"){ // 购物车为弹窗
                document.querySelectorAll('.nav-btn')[navOrder[p]].classList.add('active');
            }
        }
        switchPage('home');
        // --- 用户信息保存和读取 ---
        function saveUserInfo(e){
            e.preventDefault();
            const d = Object.fromEntries(new FormData(e.target));
            localStorage.setItem('batman_user_info', JSON.stringify(d));
            document.getElementById('user-info-saved').style.display = '';
            setTimeout(()=>{ document.getElementById('user-info-saved').style.display = 'none'; }, 2000);
        }
        function loadUserInfo(){
            const raw = localStorage.getItem('batman_user_info');
            if(raw){
                const d = JSON.parse(raw);
                const f = document.getElementById('userInfoForm');
                f.name.value = d.name||"";
                f.phone.value = d.phone||"";
            }
        }
        // --- 大图查看器 ---
        function showImgViewer(src) {
            const viewer = document.getElementById('img-viewer');
            document.getElementById('img-viewer-pic').src = src;
            viewer.style.display = 'flex';
            viewer.onclick = function(e){
                if(e.target === viewer) viewer.style.display = 'none';
            }
        }
        // --- Telegram登录信息和初始化 ---
        window.onload = function () {
            loadMenuFromSheet();
            loadUserInfo(); // 自动填充
            if (window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                window.telegramUser = user;
                document.getElementById('telegram-info').innerHTML =
                    `<b>${user.first_name || ''} ${user.last_name || ''}</b> <span style="color:#888">(ID: ${user.id})</span><br>${user.username ? '@'+user.username : ''}`;
            } else {
                document.getElementById('telegram-info').innerHTML =
                    `<span style="color:#e55">请在 Telegram 内部打开（点击菜单/按钮进入）</span>`;
            }
        }
    </script>
</body>
</html>
